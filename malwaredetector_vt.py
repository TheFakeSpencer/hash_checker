#!/usr/bin/env python3

"""
Malware Detection Tool - Virustotal
Computes static and fuzzy hashes of files and checks against known malware databases
"""

import hashlib
import ppdeep
import argparse
import requests
import json
import os
from pathlib import Path
from typing import Dict, Optional
from dotenv import load_dotenv


class MalwareDetector:
    """
    A tool for detecting potential malware by coputing file hashes
    and comparing them against known malware databases.
    """

    def __init__(self, virustotal_api_key: Optional[str] = None):
        """
        Initialize the malware detector.

        Args:
            virustotal_api_key: Optional VirusTotal API key for hash lookups
        """
        # Load from environment variables if not provided
        self.vt_api_key = virustotal_api_key or os.getenv('VIRUSTOTAL_API_KEY')
        
        self.vt_base_url = "https://www.virustotal.com/api/v3"
        
        # Warn if API keys are not set
        if not self.vt_api_key:
            print("[~] Warning: VirusTotal API key not set (VT checks will be skipped)")

    def compute_hashes(self, file_path: str) -> Dict[str, str]:
        """
        Added type annotation, since we want the output to be a dic with strings as keys/values
        {
            'md5': '5d41402abc4b2a76b9719d911017c592',      # string key: string value
            'sha256': '2c26b46b68ffc68ff99b453c1d3041341...',  # string key: string value
            'ssdeep': '3:AXGBicFlgVNhBGcL6wCrFQEv:...'        # string key: string value
        }
        Compute MD5, SHA256, and SSDEEP fuzzy hash for a file.
        
        Args:
            file_path: Path to the file to analyze
             
        Returns:
            Dictionary containing the computed hashes
        """
        md5_hash = hashlib.md5()
        sha256_hash = hashlib.sha256()
        
        print(f"[*] Computing hashes for: {file_path}")

        # Read and compute the hashes 
        try:
            with open(file_path, 'rb') as f:
                file_data = f.read()
                md5_hash.update(file_data)
                sha256_hash.update(file_data)
                fuzzy_hash = ppdeep.hash(file_data)

        except Exception as e:
            print(f"[!] Error reading file: {e}")
            return {}
        
        hashes = {
            'md5': md5_hash.hexdigest(),
            'sha256': sha256_hash.hexdigest(),
            'ssdeep': fuzzy_hash
        }

        print(f"[+] MD5:      {hashes['md5']}")
        print(f"[+] SHA256:   {hashes['sha256']}")
        print(f"[+] SSDEEP:   {hashes['ssdeep']}")

        return hashes

    def check_virustotal(self, file_hash: str) -> Dict:
        """
        Check hash against VirusTotal database.
        
        Args:
            file_hash: SHA256 or MD5 hash to check
            
        Returns:
            API response data
        """
        if not self.vt_api_key:
            print("[~] Skipping VirusTotal (no API key provided)")
            return {}
        
        print(f"\n[*] Checking VirusTotal for hash: {file_hash}")
        
        try:
            headers = {
                'x-apikey': self.vt_api_key
            }
            
            url = f"{self.vt_base_url}/files/{file_hash}"
            response = requests.get(url, headers=headers, timeout=10)
            
            if response.status_code == 200:
                result = response.json()
                stats = result.get('data', {}).get('attributes', {}).get('last_analysis_stats', {})
                
                print("[*] VirusTotal Results:")
                print(f"    Malicious: {stats.get('malicious', 0)}")
                print(f"    Suspicious: {stats.get('suspicious', 0)}")
                print(f"    Undetected: {stats.get('undetected', 0)}")
                print(f"    Harmless: {stats.get('harmless', 0)}")
                
                if stats.get('malicious', 0) > 0:
                    print("[!] WARNING: File flagged as malicious by VT engines!")
                    
                return result
            elif response.status_code == 404:
                print("[+] Hash not found in VirusTotal (file may be new or clean)")
            else:
                print(f"[!] VirusTotal API error: {response.status_code}")
                
            return {}
            
        except Exception as e:
            print(f"[!] Error querying VirusTotal: {e}")
            return {}
        
    def analyze_file(self, file_path: str) -> Dict:
        """
        Perform complete analysis of a file.
        
        Args: 
            file_path: path to file to analyze
        Returns:
            Complete analysis results    
        """
        if not Path(file_path).exists():
            print(f"[!] File not found: {file_path}")
            return {}
        
        # Compute hashes
        hashes = self.compute_hashes(file_path)
        if not hashes:
            return {}
        
        # Check against databases
        vt_result = self.check_virustotal(hashes['sha256'])

        # Compile results
        results = {
            'file': file_path,
            'hashes': hashes,
            'virustotal': vt_result,
            'threat_detected': False
        }

        # Determine if threat was detected
        if vt_result:
            stats = vt_result.get('data', {}).get('attributes', {}).get('last_analysis_stats', {})
            if stats.get('malicious', 0) > 0:
                results['threat_detected'] = True
        
        return results


    
def main():
    parser = argparse.ArgumentParser(
        description = 'Malware Detection Tool - Compute hashes and check against VirusTotal'
    )
    parser.add_argument(
        'file',
        help='Path to file to analyze'
    )
    parser.add_argument(
        '--vt-api-key',
        help='VirusTotal API key (or set VIRUSTOTAL_API_KEY env var)',
        default=None
    )
    parser.add_argument(
        '--env-file',
        help='Path to .env file (default: .env in current directory)',
        default='.env'
    )
    parser.add_argument(
        '--output',
        help='Output results to JSON file',
        default=None
    )
    
    args = parser.parse_args()

    if os.path.exists(args.env_file):
        print(f"[*] Loading environment variables from {args.env_file}")
        load_dotenv(args.env_file)
    else:
        # Try default .env in current directory
        load_dotenv()

    # Create detector instance (will use env vars if command line args not provided)
    detector = MalwareDetector(
        virustotal_api_key=args.vt_api_key
    )
     # Analyze file
    print("="*60)
    print("Malware Detection Tool")
    print("="*60)
    
    results = detector.analyze_file(args.file)
    
    # Print summary
    print("\n" + "="*60)
    print("ANALYSIS SUMMARY")
    print("="*60)
    
    if results.get('threat_detected'):
        print("[!] THREAT DETECTED - File matched known malware signatures!")
    else:
        print("[+] No known threats detected (file may be clean)")
    
    # Save results if requested
    if args.output and results:
        with open(args.output, 'w') as f:
            json.dump(results, f, indent=2)
        print(f"\n[+] Results saved to: {args.output}")
    
    print("="*60)


if __name__ == '__main__':
    main()